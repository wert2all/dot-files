#!/bin/bash
# Generated by Claude
#
# Function to find Bose device MAC address
find_bose_mac() {
  echo "Searching for Bose devices..."
  # Search for devices containing "Bose" in their name
  DEVICES=$(bluetoothctl devices | grep -i "bose")

  if [ -z "$DEVICES" ]; then
    echo "No Bose devices found. Please make sure your device is paired."
    exit 1
  fi

  # If multiple devices found, let user choose
  NUM_DEVICES=$(echo "$DEVICES" | wc -l)
  if [ $NUM_DEVICES -gt 1 ]; then
    echo "Multiple Bose devices found. Please select one:"
    echo "$DEVICES" | nl
    read -p "Enter the number of your device (1-$NUM_DEVICES): " SELECTION

    if ! [[ "$SELECTION" =~ ^[0-9]+$ ]] || [ "$SELECTION" -lt 1 ] || [ "$SELECTION" -gt $NUM_DEVICES ]; then
      echo "Invalid selection"
      exit 1
    fi

    BOSE_MAC=$(echo "$DEVICES" | sed -n "${SELECTION}p" | cut -d ' ' -f 2)
    DEVICE_NAME=$(echo "$DEVICES" | sed -n "${SELECTION}p" | cut -d ' ' -f 3-)
  else
    BOSE_MAC=$(echo "$DEVICES" | cut -d ' ' -f 2)
    DEVICE_NAME=$(echo "$DEVICES" | cut -d ' ' -f 3-)
  fi

  echo "Selected device: $DEVICE_NAME ($BOSE_MAC)"
  return 0
}

# Function to check if device is already connected
check_connection() {
  bluetoothctl info $BOSE_MAC | grep "Connected: yes" >/dev/null
  return $?
}

# Function to get device name
get_device_name() {
  bluetoothctl info $BOSE_MAC | grep "Name" | cut -d ":" -f2 | xargs
}

echo "Starting Bose headphones reconnection script..."

# Check if bluetooth service is running
if ! systemctl is-active --quiet bluetooth; then
  echo "Bluetooth service is not running. Starting bluetooth..."
  sudo systemctl start bluetooth
  sleep 2
fi

# Check if bluetooth is powered on
if ! bluetoothctl show | grep "Powered: yes" >/dev/null; then
  echo "Bluetooth is powered off. Powering on..."
  bluetoothctl power on
  sleep 2
fi

# Find Bose device MAC address
find_bose_mac

# Always disconnect first if connected
if check_connection; then
  DEVICE_NAME=$(get_device_name)
  echo "$DEVICE_NAME is connected. Disconnecting first..."
  bluetoothctl disconnect $BOSE_MAC
  sleep 2
fi

# Try to connect to the device
echo "Attempting to connect to Bose headphones..."
bluetoothctl connect $BOSE_MAC

# Wait for connection
sleep 3

# Verify connection
if check_connection; then
  DEVICE_NAME=$(get_device_name)
  echo "Successfully connected to $DEVICE_NAME"
  exit 0
else
  echo "Failed to connect. Trying alternative method..."

  # Try disconnecting and reconnecting again
  bluetoothctl disconnect $BOSE_MAC
  sleep 2
  bluetoothctl connect $BOSE_MAC
  sleep 3

  if check_connection; then
    DEVICE_NAME=$(get_device_name)
    echo "Successfully connected to $DEVICE_NAME"
    exit 0
  else
    echo "Connection failed. Please ensure your headphones are in pairing mode"
    exit 1
  fi
fi
